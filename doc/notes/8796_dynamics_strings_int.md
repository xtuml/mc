---

This work is licensed under the Creative Commons CC0 License

---

# Dynamic Strings in the xtuml2masl Chain
### xtUML Project Implementation Note

1. Abstract
-----------

`m2x` and `x2m` operate on string data using dynamically allocated and
sized strings.  `masl` has been compiled with fixed length strings.
This is not working, because the tool chain is now processing the
longer strings associated with code blocks (activity bodies stored
in string values).

2. Document References
----------------------
<a id="2.1"></a>2.1 [#8796 turn on dynamic strings in masl](https://support.onefact.net/issues/8796) -- This is the parent issue.

3. Background
-------------
MC-3020 defaults to using fixed length strings marked with a maximum
length, (`TagMaximumStringLength`) which turns into a constant
in the generated code (`ESCHER_SYS_MAX_STRING_LEN`).  MC-3020 supports
dynamic memory allocation (`TagDynamicMemoryAllocationOn`).  MC-3020
also supports a special mode with strings as part of a model compilation
feature (`TagInstanceLoading`).

The _InstanceLoading_ mode of string handling reallocates a string
each time it is copied or added to another.  This allows for strings
to start at length zero and grow to any size needed.  It is unbounded
and inefficient for large strings involved in heavy string arithmetic,
but it is flexible and has served very well for `escher` (mcmc) and
`docgen`.

4. Requirements
---------------
4.1 Mark `InstanceLoading` on `masl` model compilation.  
4.2 Fix all of the hand-edited and hand-crafted realized code to
match the string processing rules of the above marking.  

5. Design
---------
5.1 Turn On InstanceLoading  
In /masl/gen/system.mark, `.invoke TagInstanceLoading()`.  

5.2 Fix hand-craft code  
Most of the `.c` and `.h` files in the /masl/gen folder interface
with generated code passing strings and doing arithmetic on strings.
This code needs to be modified to follow the pattern generated by
TagInstanceLoading.

6. Work Required
----------------
as outlined in the design

7. Implementation Comments
--------------------------
7.1 `maslin_new` and `maslout`  
While fixing up the realized code in `masl`, I took the time to make
the implementations of `STRING_bridge.c` consistent between these 
three projects.  They all use this EE, but the hand-crafted files were
not the same; they can be the same.  So, they are now
identical except where file paths require a minor difference.

7.2 `maslin_new` SQL Interface Reference  
The maslin project was referring to an interface in the `masldoc`
project.  Every other reference to the SQL interface is referring
to `mcshared`.  I changed maslin to be referring to mcshared.

8. Unit Test
------------
8.1 MASL Standalone Test  
In the /masl/gen folder, there is a README file called `HOWTO_test_MASL.md`.
This file outlines a simple test.  Run this test, but use a name that is
longer than 18000 characters (250 lines).  
8.1.1 The old mcmasl will fail.  The new mcmasl will pass.  

9. User Documentation
---------------------
None

10. Code Changes
----------------
Fork/Repository:  cortlandstarrett/mc  
Branch:  8796_dynamicstrings2  

<pre>

 doc/notes/8796_dynamics_strings_int.md                             |  98 ++++++++++++++++++++++++
 model/masl/.externalToolBuilders/Model Compiler.launch             |   4 +-
 model/masl/gen/STRING_bridge.c                                     | 226 ++++++++++++++++++++++++++++++++++++++++++++++---------
 model/masl/gen/T_bridge.c                                          |  19 ++++-
 model/masl/gen/T_bridge.h                                          |   6 +-
 model/masl/gen/masl_population_class.c                             |  64 ++++++++++------
 model/masl/gen/out_bridge.c                                        |   2 +-
 model/masl/gen/sys_user_co.c                                       |  12 +--
 model/masl/gen/system.mark                                         |   3 +-
 model/maslin_new/gen/STRING_bridge.c                               | 154 ++++++++++++++++++++++++++++++++++---
 model/maslin_new/gen/system.mark                                   |   2 +-
 model/maslin_new/models/maslin_new/lib/masl2xtuml/masl2xtuml.xtuml |   6 +-
 model/maslout/.externalToolBuilders/Model Compiler.launch          |   4 +-
 model/maslout/gen/STRING_bridge.c                                  |  47 ++++++++++--
 model/maslout/gen/system.mark                                      |   2 +-
 15 files changed, 553 insertions(+), 96 deletions(-)

</pre>


End
---

